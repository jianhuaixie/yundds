<?php/** * ECTouch Open Source Project * ============================================================================ * Copyright (c) 2012-2014 http://ectouch.cn All rights reserved. * ---------------------------------------------------------------------------- * 文件名称：GroupbuyModel.class.php * ---------------------------------------------------------------------------- * 功能描述：ECTOUCH 红包模型 * ---------------------------------------------------------------------------- * Licensed ( http://www.ectouch.cn/docs/license.txt ) * ---------------------------------------------------------------------------- *//* 访问控制 */defined('IN_ECTOUCH') or die('Deny Access');class BonusModel extends BaseModel {    /**     * 取得某页的所有团购活动     * @param   int     $size   每页记录数     * @param   int     $page   当前页     * @return  array     */	function add_bonus($user_id, $bouns_sn){		/* 查询红包序列号是否已经存在 */		$sql = 'SELECT bonus_id, bonus_sn, user_id, bonus_type_id FROM '.$this -> pre.'user_bonus  WHERE bonus_sn = '.$bouns_sn;		$row = $this->query($sql);		if(empty($row)){			return '优惠券不存在';		}		/* 查询红包类型*/		$row = $row[0];		$type_id = $row['bonus_type_id'];		$sql = 'SELECT send_type,type_id,number FROM '.$this -> pre.'bonus_type WHERE type_id = '.$type_id;		$res = $this->query($sql);		$res = $res[0];						/* 判断红包是否为第四类 */		if ($res['send_type']=='4'){			$sql = 'SELECT user_id  FROM '.$this -> pre.'user_bonus WHERE user_id = ' .$user_id .' and bonus_sn='.$bouns_sn;						$result = $this->query($sql);		   if ($result){				//红包已经添加过了。				return '该优惠券你已经领取过了！';							   			}else{							$sql = 'SELECT send_end_date, use_end_date  FROM '.$this -> pre.'bonus_type WHERE type_id = ' . $res['type_id'];								$bonus_time = $this->query($sql);				$bonus_time = $bonus_time[0];				$now = gmtime();								if ($now > $bonus_time['use_end_date']){					return '优惠券已经过期了！';				 }							$sql = 'INSERT INTO ' . $this->pre . "user_bonus(user_id,bonus_sn,bonus_type_id) VALUES ({$user_id},{$bouns_sn},{$res['type_id']})";								 $result = $this->query($sql);				 				if ($result){					return 1;				}else{					 return '优惠卷领取失败！';				}			}		}else if($res['send_type']=='5'){										$sql = 'SELECT send_end_date, use_end_date  FROM '.$this -> pre.'bonus_type WHERE type_id = ' . $res['type_id'];								$bonus_time = $this->query($sql);				$bonus_time = $bonus_time[0];				$now = gmtime();								if ($now > $bonus_time['use_end_date']){					return '优惠券已经过期了！';				 }						/* 判断红包是否为第五类 */			/* 查询是是否超过红包领取上限 */			$sql = 'SELECT user_id  FROM '.$this -> pre.'user_bonus WHERE user_id = ' .$user_id .' and bonus_sn='.$bouns_sn;			$bonus_number = $this->query($sql);					$number = empty($bonus_number)?'0':count($bonus_number);			if($number<$res['number']){							$sql = 'INSERT INTO ' . $this->pre . "user_bonus(user_id,bonus_sn,bonus_type_id) VALUES ({$user_id},{$bouns_sn},{$res['type_id']})";								 $result = $this->query($sql);				 				if ($result){					return 1;				}else{					 return '优惠卷领取失败！';				}			}else{				return '您来晚了，优惠卷已经被领取完了！';			}		}else{			if ($row['user_id']== $user_id){				//红包已经添加过了。				  return '该优惠券你已经领取过了，不要贪心哦！';			}else{				//红包已经添加过了。				return '优惠券已经添加过了';			}			//return false; */		}	}	}